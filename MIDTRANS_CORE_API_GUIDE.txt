â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MIDTRANS CORE API INTEGRATION GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… IMPLEMENTATION COMPLETE - Core API Only

This guide explains the complete Midtrans Core API payment flow that has been
implemented in this project. Unlike Snap (which provides a hosted payment page),
Core API gives direct control over the payment process.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. PAYMENT FLOW OVERVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USER CREATES ORDER
    â†“
Checkout component validates and calls OrderService::createOrder()
    â†“
MidtransService::createTransaction() is called with order + payment method
    â†“
Core API /charge endpoint creates transaction (returns payment instructions)
    â†“
Payment record is saved to database with transaction details
    â†“
User is redirected to Payment page (livewire.payment) with instructions
    â†“
User follows payment instructions (e.g., transfer to Virtual Account)
    â†“
User completes payment at bank
    â†“
Midtrans sends webhook notification to /midtrans/notification
    â†“
MidtransController::notification() processes callback
    â†“
Payment model status is updated (payment.transaction_status = 'settlement')
    â†“
Order status is updated (order.payment_status = 'paid')
    â†“
Payment page auto-refreshes and shows success message

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2. CONFIGURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

File: /config/midtrans.php

Environment variables required in .env:
    MIDTRANS_SERVER_KEY=your_server_key_from_midtrans
    MIDTRANS_CLIENT_KEY=your_client_key_from_midtrans
    MIDTRANS_IS_PRODUCTION=false (set to true in production)
    MIDTRANS_NOTIFICATION_URL=https://yoursite.com/midtrans/notification
    MIDTRANS_CURRENCY=IDR
    MIDTRANS_TRANSACTION_TIMEOUT=30

The notification URL MUST be publicly accessible for Midtrans webhook callbacks.
In development, use ngrok or similar to expose your local server.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
3. KEY FILES AND THEIR ROLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ config/midtrans.php
   â””â”€ Configuration for Core API endpoints and callbacks

ğŸ“ app/Services/MidtransService.php
   â”œâ”€ createTransaction($order, $paymentMethod)
   â”‚  â””â”€ Creates payment via Core API /charge endpoint
   â”‚  â””â”€ Extracts payment instructions from response
   â”‚  â””â”€ Saves payment record to database
   â”‚
   â”œâ”€ getTransactionStatus($orderId)
   â”‚  â””â”€ Check payment status anytime from Midtrans
   â”‚
   â””â”€ extractPaymentInstructions($transactionData)
      â””â”€ Formats VA numbers, QRIS codes, e-wallet links for UI display

ğŸ“ app/Http/Controllers/MidtransController.php
   â”œâ”€ notification(Request $request) - WEBHOOK ENDPOINT
   â”‚  â””â”€ Receives POST from Midtrans with payment status updates
   â”‚  â””â”€ Validates signature (security)
   â”‚  â””â”€ Updates Payment and Order models
   â”‚  â””â”€ Must return 200 OK to confirm receipt
   â”‚
   â”œâ”€ finish(Request $request) - User redirect after payment
   â”‚  â””â”€ Redirects to Payment page when user returns from bank
   â”‚
   â”œâ”€ unfinish(Request $request) - User redirect if still pending
   â”‚  â””â”€ Redirects to Payment page when payment not yet confirmed
   â”‚
   â””â”€ error(Request $request) - User redirect if payment fails
      â””â”€ Redirects to Payment page with error status

ğŸ“ app/Models/Payment.php
   â”œâ”€ Stores all payment transaction details
   â”œâ”€ updateFromMidtransNotification(array $notification)
   â”‚  â””â”€ Called when webhook arrives from Midtrans
   â”‚  â””â”€ Updates transaction_status, fraud_status, etc.
   â”‚  â””â”€ Calls updateOrderStatusFromPayment() to update Order
   â”‚
   â””â”€ isSuccessful(): bool
      â””â”€ Returns true if settlement/capture AND fraud_status is accept or null

ğŸ“ app/Models/Order.php
   â”œâ”€ Stores order information
   â””â”€ updatePaymentStatus($transactionStatus, $fraudStatus)
      â””â”€ Updates order.payment_status and order.status based on transaction

ğŸ“ app/Livewire/Payment.php
   â””â”€ Displays payment instructions to customer
   â””â”€ Shows Virtual Account number, QRIS code, etc.
   â””â”€ No Snap integration (Pure Core API)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
4. PAYMENT STATUS TRANSITIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Midtrans Transaction Status Values:
    â€¢ pending        = Waiting for customer payment
    â€¢ settlement     = Payment confirmed (settled in customer's bank)
    â€¢ capture        = Payment captured (for credit card)
    â€¢ deny           = Payment rejected
    â€¢ cancel         = Payment cancelled
    â€¢ expire         = Transaction expired (timeout)

Order Status Updates:
    pending       â”€â”€â†’ SETTLEMENT/CAPTURE (fraud=accept) â”€â”€â†’ processing
    pending       â”€â”€â†’ DENY/CANCEL/EXPIRE â”€â”€â†’ payment_failed

Key Rule: Payment is only marked "paid" when BOTH conditions are true:
    1. transaction_status is "settlement" OR "capture"
    2. fraud_status is "accept" OR null (if not checked)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
5. PAYMENT METHODS (CORE API)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Currently Configured in app/Livewire/Checkout.php:

Virtual Accounts (Bank Transfer):
    â€¢ bank-transfer-bca  â†’ BCA Virtual Account (e.g., 12345678901234567890)
    â€¢ bank-transfer-bni  â†’ BNI Virtual Account (e.g., 12345678901234)
    â€¢ bank-transfer-bri  â†’ BRI Virtual Account (e.g., 12345678901234567)

Each method is handled by PaymentMethod model which provides:
    â€¢ getCoreApiConfig() - Returns Core API payload structure
    â€¢ getPaymentInstructions() - Returns user-friendly instructions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
6. WEBHOOK SECURITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

All notifications from Midtrans are validated using:
    â€¢ Signature verification with SHA-512
    â€¢ Server key from config
    â€¢ Hash formula: SHA512(order_id + status_code + gross_amount + server_key)

Implementation in MidtransController::isValidSignature()
    - Rejects notifications with invalid signatures
    - Logs warning for security audit

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
7. TESTING THE INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Setup Environment
    1. Add MIDTRANS credentials to .env
    2. Make sure MIDTRANS_IS_PRODUCTION=false for sandbox
    3. Expose localhost webhook endpoint with ngrok:
       ngrok http 8000

    4. Update MIDTRANS_NOTIFICATION_URL in .env:
       MIDTRANS_NOTIFICATION_URL=https://your-ngrok-url.ngrok.io/midtrans/notification

STEP 2: Create Test Order
    1. Access http://localhost/checkout
    2. Fill all checkout fields
    3. Select any bank transfer method
    4. Click "Buat Pesanan"
    5. Note the order number displayed

STEP 3: Verify Payment Created
    1. Go to /payment/{order-number}
    2. You should see Virtual Account number and instructions
    3. Check logs: tail -f storage/logs/laravel.log
    4. Look for: "Midtrans Core API Response"

STEP 4: Simulate Payment (Sandbox Only)
    1. In Midtrans dashboard, use Test Transaction tool
    2. Or use curl to simulate notification:

    curl -X POST http://localhost/midtrans/notification \
      -H "Content-Type: application/json" \
      -d '{
        "order_id": "ORD-20251216-xxxxx",
        "transaction_status": "settlement",
        "fraud_status": "accept",
        "status_code": "200",
        "gross_amount": "50000",
        "signature_key": "...",
        "payment_type": "bank_transfer",
        "transaction_id": "0123456789012345",
        "transaction_time": "2025-12-16 10:00:00"
      }'

STEP 5: Verify Status Update
    1. Check Payment record: Payment::where('order_id', $orderId)->first()
       - transaction_status should be 'settlement'
       - fraud_status should be 'accept'
    
    2. Check Order record: Order::where('order_number', $orderNumber)->first()
       - payment_status should be 'paid'
       - status should be 'processing'

STEP 6: View Order Detail
    1. Go to /order/{order-number}
    2. Should show payment_status as "Paid"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
8. TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Problem: "Midtrans server_key not configured"
Solution: Add MIDTRANS_SERVER_KEY to .env and run php artisan config:cache

Problem: "Invalid signature" warning in notification
Solution: Verify MIDTRANS_SERVER_KEY matches credentials in Midtrans dashboard
         Check that order_id, status_code, gross_amount are not tampered

Problem: Notification webhook not received
Solution: 
    1. Verify MIDTRANS_NOTIFICATION_URL is publicly accessible
    2. Check firewall/security rules allow POST from Midtrans IPs
    3. Use ngrok for local testing
    4. Monitor logs for webhook attempts

Problem: Order not updated to "paid" after payment
Solution:
    1. Check Payment record exists
    2. Verify transaction_status = 'settlement' (not 'pending')
    3. Check fraud_status = 'accept' or null
    4. Review Payment::updateFromMidtransNotification() was called
    5. Check Order::updatePaymentStatus() conditions

Problem: "Order not found" in notification
Solution: Ensure order_number in notification matches Order.order_number
         Check notification payload is not being modified

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
9. DATABASE TABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

payments table:
    â”œâ”€ id
    â”œâ”€ order_id (FK to orders)
    â”œâ”€ payment_gateway = 'midtrans'
    â”œâ”€ transaction_id (from Midtrans)
    â”œâ”€ transaction_status (pending/settlement/capture/deny/cancel/expire)
    â”œâ”€ fraud_status (accept/deny/null)
    â”œâ”€ payment_type (bank_transfer/echannel/gopay/etc)
    â”œâ”€ payment_channel (bca/bni/bri/gopay/etc)
    â”œâ”€ gross_amount
    â”œâ”€ currency = 'IDR'
    â”œâ”€ signature_key (for webhook validation)
    â”œâ”€ status_code
    â”œâ”€ status_message
    â”œâ”€ midtrans_response (full JSON from Midtrans)
    â”œâ”€ snap_token (deprecated, no longer used)
    â”œâ”€ snap_redirect_url (deprecated, no longer used)
    â”œâ”€ paid_at
    â”œâ”€ expired_at
    â”œâ”€ refunded_at
    â””â”€ timestamps

payment_notifications table:
    â”œâ”€ id
    â”œâ”€ payment_id (FK to payments)
    â”œâ”€ order_id
    â”œâ”€ transaction_status
    â”œâ”€ notification_body (full JSON webhook payload)
    â”œâ”€ processed (boolean, tracks if notification was processed)
    â”œâ”€ processed_at
    â””â”€ timestamps

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
10. IMPORTANT NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ CORE API ONLY - Snap integration has been removed completely
âœ“ NO CLIENT-SIDE LIBRARIES - No need for Snap.js
âœ“ PAYMENT INSTRUCTIONS - Display virtual account, QRIS, etc. on backend
âœ“ WEBHOOK PROCESSING - All status updates come from server notifications
âœ“ FRAUD DETECTION - Supports fraud_status from Midtrans risk checks
âœ“ SIGNATURE VALIDATION - All webhooks verified with SHA-512

Data Flow Security:
    â€¢ All sensitive operations happen server-side
    â€¢ Webhook signatures validated before processing
    â€¢ No payment data exposed to client
    â€¢ Transaction details stored securely in database

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
END OF GUIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
